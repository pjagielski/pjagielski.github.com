--- 
name: oauth-logging-in-grails-made-easy-with
layout: post
time: 2012-04-10 23:57:00 +02:00
title: OAuth login in Grails made easy with scribe-java
---
<p><a href="http://grails.org/plugin/spring-security-core">Grails Spring Security</a> is a great plugin. It allows you to setup authorization for your app in just a few lines in Grails configuration. So, users can register to your website, click on confirmation link received by email and login with username and password. User experience? Maybe not as friendy as could be :) </p><p>So here comes OAuth. As almost everybody on the planet have account on one of the social networks, why we can ask this network to authorize user of our application? User logins with his/her credentials to Facebook/Google+/whatever (called OAuth provider) and gives access permission to our application. OAuth provider redirects to your website telling that user has been authorized and giving you some basic information about the user. No password storing in database of your application! </p><p>OK, so we have grails-spring-security-facebook and twitter plugins. But what with other providers? Recently, i've released a website for developers. Do developers have Facebook account? Maybe 50%... Rather Twitter/Google+/LinkedIn/GitHub(!). All of these are OAuth providers. But where are the Grails plugins? </p><p>After googling a bit i've found <a href="http://grails.org/plugin/inviter">grails-inviter</a> plugin by Tomas Lin. It allows you to import your friends' contacts and send them email invitation to your website. Underneath the plugin uses <a href="https://github.com/fernandezpablo85/scribe-java">scribe-java</a> library - open source implementation of OAuth 1/2 protocol. So why not use scribe-java for authentication of users from various social networks in your application?<br />Scribe is sort of low-level implementation of OAuth. Here's a list of it's main elements:<br/><ul><li>ServiceBuilder - is an abstract factory that lets you build service for concrete OAuth provider, giving your app apiKey and apiSecret</li><li>Verifier - OAuth verifier code sent by the OAuth provider which is used to create the access token</li><li>OAuthRequest - request to OAuth provider which is signed by the access token</li></ul></p><p>You can look at <a href="https://github.com/fernandezpablo85/scribe-java/wiki/getting-started">Getting Started</a> page for more details.<br /></p><p>To implement authentication we need to implement following: <br /><ul><li>With ServiceBuilder create and redirect to authorization URL to OAuth provider</li><li>Implement callback action which extracts access token from verifier code given by the OAuth provider</li><li>Create and sign OAuth request to receive user information (*)</li><li>Inject user principal into the Spring Security context.</li></ul><br />(*) - you can also extract user data e.g. from Facebook cookie, but using separate OAuth request is much more readable and compatible with all providers. </p><a name='more'></a><p>OK, so we would write AuthController to handle signin in by social account and callback from OAuth provider:<br /><script src="https://gist.github.com/2354698.js?file=AuthController.groovy"></script></p><p>As you can see - besides from storing some data into session, the main logic is implemented in GrailsOAuthService class- kind of wrapper for scribe-java api. Here is sample implementation for Google+:<br /><script src="https://gist.github.com/2352284.js?file=GoogleAuthService.groovy"></script> </p><p>Last but not least - we need to extract user data by accessing providers specific URL with request signed with access token. URLs are listed in the table below:<br /><table class="table"><tbody><tr><th>PROVIDER</th><th>URL</th></tr><tr><td>Facebook</td><td>https://graph.facebook.com/me</td></tr><tr><td>Google+</td><td>https://www.googleapis.com/oauth2/v1/userinfo</td></tr><tr><td>Twitter</td><td>http://api.twitter.com/1/account/verify_credentials.json</td></tr><tr><td>LinkedIn</td><td>http://api.linkedin.com/v1/people/~</td></tr><tr><td>GitHub</td><td>https://github.com/api/v2/json/user/show</td></tr></tbody></table><br />The structure of returned user profile is also provider specific - mostly returned by some JSON object. Here's example code for Google+:<br /><script src="https://gist.github.com/2354774.js?file=profile.groovy"></script> </p><p>The last part is injecting principal object into Spring Security. Suppose we use standard grails-spring-security model classes to store user data, this is example code:<br /><script src="https://gist.github.com/2352133.js?file=SpringSecuritySigninService.groovy"></script> <br />And we have fully authenticated UserDetails object with @Secured annotation compatible authorities.<br />Enjoy!</p><div></div>
