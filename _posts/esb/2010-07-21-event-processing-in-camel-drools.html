--- 
name: event-processing-in-camel-drools
title: Event processing in camel-drools
time: 2010-07-21 13:38:00 +02:00
layout: post
---
In a <a href="http://touk.pl/blog/?p=146">previous post about camel-drools</a> I've introduced <a href="https://github.com/TouK/camel-drools">camel-drools component</a> and implemented some simple task-oriented process using rules inside Camel route. Today I'll show how to extend this example by adding <a href="http://en.wikipedia.org/wiki/Complex_event_processing">event processing</a>.<br /><br />So how to describe an event? Each event occur at some time and lasts for some duration, events happen in some particular order. We have then a 'cloud of events' from which we want to identify those, which form some interesting correlations. And here the usage of Drools becomes reasonable - we don't have to react for each event, just describe set of rules and consequences for those interesting correlations. Drools engine will find them and fire matching rules.<br /><br />Suppose our system has to monitor execution of task assigned to users. After a task is created, user has 10 days to complete it. When he doesn't - an e-mail remainder should be sent.<br /><a name='more'></a><br /><span id="fullpost"><br />Rule definition may look like this:<br /><br /><pre class="brush:java">import org.apache.camel.component.drools.stateful.model.*<br />global org.apache.camel.component.drools.CamelDroolsHelper helper<br /><br />declare TaskCreated<br />&nbsp;&nbsp;&nbsp; @role( event )<br />&nbsp;&nbsp;&nbsp; @expires( 365d )<br />end<br /><br /><br />declare TaskCompleted<br />&nbsp;&nbsp;&nbsp; @role( event )<br />&nbsp;&nbsp;&nbsp; @expires( 365d )<br />end<br /><br />rule "Task not completed after 10 days"<br />&nbsp;&nbsp;&nbsp; when<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $t : TaskCreated()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; not(TaskCompleted(name==$t.name, this after [-*, 10d] $t))<br />&nbsp;&nbsp;&nbsp; then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; helper.send("direct:escalation", $t.getName());<br />end&nbsp;</pre><pre class="brush:java">&nbsp;</pre>As you can see, there are two types of events: TaskCreated - when system assigns task to users, and TaskCompleted - when user finishes task. We correlate those two by the 'name' property.<br />Firstly, we need to declare our model classes as events by adding @role(event) and @expires annotations.<br />Then we describe rule: 'when there are is no TaskCompleted event after 10 days of TaskCreated event, send task name to direct:escalation route'. Again, this could be example of declarative programming - we don't event have to specify actual names of tasks, just correlate TaskCreated with TaskCompleted events by name.<br /><br />In this example, I used 'after' temporal operator. For description of others - see <a href="http://downloads.jboss.com/drools/docs/5.0.1.26597.FINAL/drools-fusion/html/ch02.html#d0e558">Drools Fusion documentation</a>.<br /><br />And finally, here is JUnit test code snippet:<br /><br /><pre class="brush:java">public class TaskEventsTest extends GenericTest {<br /><br />    DefaultCamelContext ctx;<br /><br />    @Test<br />    public void testCompleted() throws Exception {<br />        insertAdvanceDays(new TaskCreated("Task1"), 4);<br />        assertContains(0);<br />        insertAdvanceDays(new TaskCompleted("Task1"), 4);<br />        advanceDays(5);<br />        assertContains(0);<br />    }<br /><br />    @Test<br />    public void testNotCompleted() throws Exception {<br />        insertAdvanceDays(new TaskCreated("Task1"), 5);<br />        assertContains(0);<br />        advanceDays(5);<br />        assertContains("Task1");<br />    }<br /><br />    @Test<br />    public void testOneNotCompleted() throws Exception {<br />        ksession.insert(new TaskCreated("Task1"));<br />        insertAdvanceDays(new TaskCreated("Task2"), 5);<br />        assertContains(0);<br />        insertAdvanceDays(new TaskCompleted("Task1"), 4);<br />        assertContains(0);<br />        advanceDays(1);<br />        assertContains("Task2");<br />        advanceDays(10);<br />        assertContains("Task2");<br />    }<br />    <br />    @Override<br />    protected void setUpResources(KnowledgeBuilder kbuilder) throws Exception {<br />        kbuilder.add(new ReaderResource(new StringReader(<br />                IOUtils.toString(getClass()<br />                 .getResourceAsStream("/stateful/task-event.drl")))), <br />                 ResourceType.DRL);<br />    }<br />    <br />    @Override<br />    public void setUpInternal() throws Exception {<br />        this.ctx = new DefaultCamelContext();<br />        CamelDroolsHelper helper = new CamelDroolsHelper(ctx, <br />                new DefaultExchange(ctx)) {<br />            public Object send(String uri, Object body) {<br />                sentStuff.add(body.toString());<br />                return null;<br />            };<br />        };<br />        ksession.setGlobal("helper", helper);<br />    }<br />}<br /></pre><br />You can find source code for this example <a href="https://github.com/TouK/camel-drools/blob/master/src/test/resources/stateful/task-event.drl">here</a>.<br /></span>
